# 云积分会员通系统
电商平台会员通系统

## 简介
分布式微服务项目，实现了品牌CRM系统与电商平台线上线下会员绑定、解绑，积分、等级变更同步，会员订单数据推送，商品同步等业务，提供内部商家后台管理系统和电商平台内嵌小程序的接口。

## 技术架构
Spring Cloud Alibaba、Spring Boot、MySQL、Redis、MyBatis、Kafka、xxl-job

## 项目亮点
- 分布式微服务
- 采用大量的设计模式：单例、策略模式、代理模式、工厂模式、模板方法、适配器模式、外观模式
- 动态数据源加载：MyBatis的 session 需要获取到 datasource，自定义修改 datasource 获取连接的方法（threadlocal）

## 项目中遇到的困难，以及怎么解决的？
项目代码臃肿，耦合度高
- 业务理解，资料，有的需要从老项目中提炼
- 异地沟通
- 值班问题，老项目接入的客户太多，不同品牌采用的品牌数据中心不一致，代码实现
- 订单有的是job，有的是kafka
- 对账方案不同，ftp文件服务器


## 工作职责
1. 天猫、唯品会、抖音、京东会员通平台标准化 spi 接口开发，积分等级调整业务的重试与最终一致性保障代码开发；
2. 唯品会、抖音平台会员通品牌数据中心对接，平台-品牌全链路联调，支撑项目上线；
3. 完成 gateway 网关服务阿里全域会员通、京东会员通和抖音会员通接口路由与新老服务流量分发功能；
4. 结合日志文件排查会员通线上问题，优化会员通业务代码。


## 面试问题

### 项目业务介绍？
品牌CRM系统与电商平台线上线下会员绑定、解绑，积分、等级变更同步，会员订单数据推送，商品同步

### 项目架构是怎么样的？
- 网关 -> 会员通业务链接服务 -> （内部服务交互） + 品牌数据中心服务
- 外观模式适配不同平台的
- 策略模式调用品牌CRM第三方服务

### 怎么实现多租户的？
1. 每个品牌都会有独立的数据库（数据隔离），不同电商平台下采用不同的数据库（不直接支持一个品牌一个平台下多店）
2. MyBatis的 session 需要获取到 datasource，自定义修改 datasource 获取连接的方法（threadlocal）
3. threadlocal 会存储需要加载的数据库的 lookup key，再根据缓存获取对应的数据库连接信息（已加载的数据库信息会存储在jvm本地缓存）

### 怎么保证订单消息传输的可靠性？
1. 在消费平台侧消息，写入kafka消息队列，完成后回调平台对应的状态码（成功/失败）
2. 写入kafka过程中（producer->broker），broker开启副本同步 request.required.acks = -1，保证所有副本都同步成功才认定为发送成功
3. 消费kafka消息时，手动提交偏移量（offset）

### 如何保证订单消息的唯一性？
数据库会存储订单的常用信息，根据订单号（orderSn）来保证唯一性

### xxljob主要应用的业务点？
1. 平台缓存服务存储商家与平台的认证信息（平台店铺标识，token）以及内部服务商家店铺标识信息（token需要定时刷新，php调用，清理redis缓存）
2. 订单定时拉取（京东、唯品会平台）
3. 会员通重试业务保证数据唯一性，平台同步会员绑定解绑状态
4. 策略引擎，会员订单金额门槛送礼、生日送礼等

### 数据库优化实例？
索引，在宝洁阿里全域会员通的项目中，新建表（会员站点绑定）没有创建会员唯一标识的索引，在数据量达到1000万的情况下，sql查询超时导致接口报错