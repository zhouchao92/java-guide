#### RabbitMQ 概念
![RabbitMQ基本概念](/pic/RabbitMQ基本概念.png)

#### Exchange 交换机类型
- direct 直接交换机，点对点，精准匹配
- fanout 扇出，广播，不匹配
- topic 主题，模糊匹配
- headers 

#### 延时队列
延时队列的实现：消息的 TTL + 死信路由，控制在一定时间将消息变为死信，控制变成死信的消息发送到某一个指定的交换机

##### 消息的 TTL（Time to Live）
消息存活时间，RabbitMQ 可以对队列和消息分别设置 TTL
对队列设置：队列没有消费者连接的保留时间，也可以对每一个单独的消息做单独的设置。超过这个时间，认为这个消息为死信。
队列+消息设置，取小的，一个消息如果被路由到不同的队列中，这个消息死亡的时间可能不一样。
单个消息的 TTL 设置，expiration 字段或者 x-message-ttl 属性

##### Dead Letter Exchanges （DLX）死信路由
一个消息在满足如下条件下，会进入死信路由

- 一个消息被 consumer 拒收了，并且 reject 方法的参数里 requeue 是 false，不会被再次放在队列里 （basic.reject/basic.nack）requeue = false
- 上面的消息的 TTL 到了，消息过期了
- 队列的长度限制满了，排在前面的消息会被丢弃或者扔到死信路由上

Dead Letter Exchange 也是一种普通的 exchange，只是在某一个设置 Dead Letter Exchange 的队列中有消息过期了，会自动触发消息的转发，发送到 Dead Letter Exchange 中

手动 ack 和异常消息统一放在一个队列处理建议的两种方式：

1. catch 异常后，手动发送到指定队列，然后使用 channel 给 RabbitMQ 确认消息已消费
2. 给队列绑定死信队列，使用 nack（requeue = false）确认消息消费失败

##### 下订单锁库存延时队列实战
![RabbitMQ下单锁库存延时队列实战](/pic/RabbitMQ下单锁库存延时队列实战.jpeg)

####  如何保证消息可靠性：消息丢失、消息重复、消息积压
如何保证消息可靠性-**消息丢失**

1. 消息发送出去，由于网络问题没有抵达服务器
   1. 做好容错方法（try-catch），发送消息可能会网络失败，失败后要有重试机制，可记录到数据库，采用定期扫描重发的方式
   2. 做好日志记录，每个消息状态是否被服务器收到都应该记录
   3. 做好定期充法，如果消息没有发送成功，定期去数据库扫描未成功的消息进行重发
2. 消息抵达 broker，broker 要将消息写入磁盘（持久化）才算成功，此时 broker 尚未持久化完成，宕机
   1. publisher 加入确认回调机制，确认成功的消息，修改数据库消息状态
3. 自动 ack 的状态下，消费者收到消息，但没来得及消费然后宕机
   1. 开启手动 ack，消费成功才移出，失败或者没来得及处理就 noack 并重新入队

如何保证消息可靠性-**消息重复**

1. 消息消费成功，事务已经提交，ack 时，机器宕机，导致没有 ack 成功，broker的消息重新有 unack 变为 ready，并发送给其他消费者
2. 消息消费失败，由于重试机制，自动将消息发送出去
3. 成功消费，ack 时宕机，消息由 unack 变为 ready，broker 又重新发送

- 消费者的业务消费接口设计为幂等性的
- 防重表（mysql / redis），发送消息每一个都有业务的唯一标识，处理过就不用处理
- RabbitMQ 的每一个消息都有 redelivered 字段，可以获取是否是被重新投递过来的

如何保证消息可靠性-**消息积压**

1. 消费者宕机导致积压
2. 消费者消费能力不足导致积压
3. 发送者发送流量太大

- 上线更多的消费者，进行正常消费
- 上线专门的队列消费服务，将消息先批量取出来，记录数据库，离线慢慢处理
#### Docker 安装 RabbitMQ 容器
```bash
docker run -d --name rabbitmq \
-p 5671:5671 \
-p 5672:5672 \
-p 4369:4369 \
-p 25672:25672 \
-p 15671:15671 \
-p 15672:15672 \
rabbitmq:management
```

- 4369，25672：Erlang 发现 & 集群端口
- 5672，5671：AMQP 端口
- 15672：WEB 后端管理端口
- 61613，61614：STOMP 协议端口
- 1883：MQTT 协议端口

